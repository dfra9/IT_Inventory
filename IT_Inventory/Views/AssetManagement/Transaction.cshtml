
@model global::IT_Inventory.ViewModel.AssetManagementViewModel
@{
    ViewBag.Title = "Transaction";
}

<section class="content">
    @using (Html.BeginForm("Transaction", "AssetManagement", FormMethod.Post, new { id = "assetForm" }))
    {
        @Html.AntiForgeryToken()

        <div class="card card-default">
            <div class="card-header">
                <h3 class="card-title">Asset Management</h3>

                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button type="button" class="btn btn-tool" data-card-widget="remove">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- /.card-header -->
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>No Asset</label>
                            @Html.TextBoxFor(m => m.No_asset, new { @class = "form-control", placeholder = "Input No Asset", id = "No_asset" })
                            @Html.ValidationMessageFor(m => m.No_asset, "", new { @class = "text-danger" })
                        </div>
                        <!-- /.form-group -->
                        <div class="form-group">
                            <label>Company Code</label>
                            @Html.DropDownListFor(m => m.Company_Code, Model.GetCompanyListItem(), "Select Company Code", new { @class = "form-control select2", id = "companyCodeDropdown" })
                            @Html.ValidationMessageFor(m => m.Company_Code, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group">
                            <label>Company Name</label>
                            @Html.TextBoxFor(m => m.Company_Name, new { @class = "form-control", @readonly = "readonly", id = "Company_Name" })
                        </div>
                        <div class="form-group">
                            <label>Material Group Code</label>
                            @Html.TextBoxFor(m => m.Material_Group_Code, new { @class = "form-control", placeholder = "Input Material Group Code" })
                            @Html.ValidationMessageFor(m => m.Material_Group_Code, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group">
                            <label>Material Group</label>
                            @Html.TextBoxFor(m => m.Material_Group, new { @class = "form-control", placeholder = "Input Material Group" })
                            @Html.ValidationMessageFor(m => m.Material_Group, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group">
                            <label>Material Description</label>
                            @Html.TextBoxFor(m => m.Material_Description, new { @class = "form-control", placeholder = "Input Material Description" })
                            @Html.ValidationMessageFor(m => m.Material_Description, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            @Html.TextBoxFor(m => m.Quantity, new { @class = "form-control", type = "number", placeholder = "Input Material Group Code" })
                            @Html.ValidationMessageFor(m => m.Quantity, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group">
                            <label>Unit</label>
                            @Html.TextBoxFor(m => m.Unit, new { @class = "form-control", placeholder = "Input Unit" })
                            @Html.ValidationMessageFor(m => m.Unit, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group">
                            <label>Aqcuisition Date</label>
                            @Html.TextBoxFor(m => m.Acquisition_Date, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
                            @Html.ValidationMessageFor(m => m.Acquisition_Date, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group">
                            <label>Acquisition Value</label>
                            @Html.TextBoxFor(m => m.Acquisition_value, new { @class = "form-control", type = "number" })
                            @Html.ValidationMessageFor(m => m.Acquisition_value, "", new { @class = "text-danger" })
                        </div>
                        <!-- /.form-group -->
                    </div>

                    <!-- /.col -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>No Asset PGA</label>
                            @Html.TextBoxFor(m => m.No_Asset_PGA, new { @class = "form-control", placeholder = "Input No Asset PGA" })
                            @Html.ValidationMessageFor(m => m.No_Asset_PGA, "", new { @class = "text-danger" })
                        </div>
                        <!-- /.form-group -->
                        <div class="form-group">
                            <label>No Asset Accounting</label>
                            @Html.TextBoxFor(m => m.No_Asset_Accounting, new { @class = "form-control", placeholder = "Input No Asset Accounting" })
                            @Html.ValidationMessageFor(m => m.No_Asset_Accounting, "", new { @class = "text-danger" })
                        </div>
                        <!-- /.form-group -->
                        <div class="form-group">
                            <label>No PO</label>
                            @Html.TextBoxFor(m => m.No_PO, new { @class = "form-control", placeholder = "Input No Asset Accounting" })
                            @Html.ValidationMessageFor(m => m.No_PO, "", new { @class = "text-danger" })
                        </div>
                        <!-- /.form-group -->
                        <div class="form-group">
                            <label>Latest User</label>
                            @Html.TextBoxFor(m => m.Latest_User, new { @class = "form-control", placeholder = "Input No Asset Accounting" })
                            @Html.ValidationMessageFor(m => m.Latest_User, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group">
                            <label>Departement </label>
                            @Html.DropDownListFor(m => m.Departement_Code, Model.GetDepartementListItem(), "Select Departement", new { @class = "form-control select2", id = "departementDropdown" })

                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            @Html.DropDownListFor(m => m.Locations, Model.GetLocationListItem(), "Select Location", new { @class = "form-control select2", id = "locationDropdown" })

                        </div>
                        <div class="form-group">
                            <label>City</label>
                            @Html.DropDownListFor(m => m.City_Id, Model.GetCityListItem(), "Select Location", new { @class = "form-control select2", id = "cityDropdown" })

                        </div>
                        <div class="form-group">
                            <label>Last Check Date</label>
                            @Html.TextBoxFor(m => m.Last_Check_Date, new { @class = "form-control", placeholder = "Last Check Date", type = "date" })
                            @Html.ValidationMessageFor(m => m.Last_Check_Date, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group">
                            <label>Condition</label>
                            @Html.TextBoxFor(m => m.Condition, new { @class = "form-control", placeholder = "" })
                            @Html.ValidationMessageFor(m => m.Condition, "", new { @class = "text-danger" })
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.col -->
            <!-- /.row -->
            <!-- /.card-body -->

        </div>
        <div class="card card-primary ">
            <div class="card-header">
                <h3 class="card-title">General</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>Status</label>
                    @Html.DropDownListFor(m => m.Status, new SelectList(new[]
                    {
                   new {Value = "Return", Text = "Return"},
                   new {Value = "Borrowing", Text = "Borrowing"},
                   new {Value = "Service", Text = "Service"},
                   new {Value = "Ready", Text = "Ready"},
                   new {Value = "Assign", Text = "Assign"},
                   new {Value = "Write Off", Text = "Write Off"},
               }, "Value", "Text"), "Select Status", new { @class = "form-control select2", id = "statusDropdown" })
                    @Html.ValidationMessageFor(m => m.Status, "", new { @class = "text-danger" })
                </div>
                @Html.HiddenFor(m => m.PIC, new { id = "hiddenPIC" })
                @Html.ValidationMessageFor(m => m.PIC, "", new { @class = "text-danger" })

                @Html.HiddenFor(m => m.Transaction_Date, new { id = "hiddenTransactionDate" })
                @Html.ValidationMessageFor(m => m.Transaction_Date, "", new { @class = "text-danger" })
                <div id="returnForm" class="status-form" style="display: none">
                    <div class="form-group">
                        <label>PIC / Vendor</label>
                        <input type="text" class="form-control" placeholder="PIC / Vendor" id="returnPIC" />
                    </div>
                    <div class="form-group">
                        <label>Return Date</label>
                        <input type="date" class="form-control" id="returnDate" />
                    </div>
                </div>
                <div id="borrowForm" class="status-form" style="display: none">
                    <div class="form-group">
                        <label>PIC / Vendor</label>
                        <input type="text" class="form-control" placeholder="PIC / Vendor" id="borrowPIC" />
                    </div>
                    <div class="form-group">
                        <label>Borrow Date</label>
                        <input type="date" class="form-control" id="borrowDate" />
                    </div>
                </div>
                <div id="serviceForm" class="status-form" style="display: none">
                    <div class="form-group">
                        <label>PIC / Vendor</label>
                        <input type="text" class="form-control" placeholder="PIC / Vendor" id="servicePIC" />
                    </div>
                    <div class="form-group">
                        <label>Service Date</label>
                        <input type="date" class="form-control" id="serviceDate" />
                    </div>
                </div>
                <div id="readyForm" class="status-form" style="display: none">
                    <div class="form-group">
                        <label>PIC / Vendor</label>
                        <input type="text" class="form-control" placeholder="PIC / Vendor" id="readyPIC" />
                    </div>
                    <div class="form-group">
                        <label>Available Date</label>
                        <input type="date" class="form-control" id="readyDate" />
                    </div>
                </div>
                <div id="assignForm" class="status-form" style="display: none">
                    <div class="form-group">
                        <label>PIC</label>
                        <input type="text" class="form-control" placeholder="PIC / Vendor" id="assignPIC" />
                    </div>
                    <div class="form-group">
                        <label>Assign Date</label>
                        <input type="date" class="form-control" id="assignDate" />
                    </div>
                </div>
                <div id="writeOffForm" class="status-form" style="display: none">
                    <div class="form-group">
                        <label>Approved By</label>
                        <input type="text" class="form-control" placeholder="PIC / Vendor" id="writeOffPIC" />
                    </div>
                    <div class="form-group">
                        <label>Write Off Date</label>
                        <input type="date" class="form-control" id="writeOffDate" />
                    </div>
                </div>

                <div class="form-group action-buttons">
                    <button type="button" class=" btn btn-secondary" id="btnCancel">Cancel</button>
                    <button type="button" class=" btn btn-primary float-right" id="btnSave">Save</button>
                </div>
            </div>
        </div>
          
    }
            
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                Asset History
            </h3>
            <div class="card-tools">
                <div class="input-group input-group-sm" style="width: 150px;">
                    <input type="text" name="table_search" class="form-control float-right" placeholder="Search">
                    <div class="input-group-append">
                        <button type="submit" class="btn btn-default" id="btnSearch"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body table-responsive p-0">
        <table class="table table-hover text-nowrap">
            <thead>
                <tr>
                    <th>No Assets</th>
                    <th>PIC / Vendor</th>
                    <th>Transaction Date</th>
                    <th>Status</th>
                    <th>Submit Date</th>
                </tr>
            </thead>
            <tbody id="assetHistoryTable">
                @if (Model.AssetHistory != null && Model.AssetHistory.Any())
                {
                    foreach (var item in Model.AssetHistory)
                    {
                        <tr>
                            <td>@item.No_asset</td>
                            <td>@item.PIC</td>
                            <td>@(item.Transaction_Date.HasValue ? item.Transaction_Date.Value.ToString("yyyy-MM-dd"): "")</td>
                            <td>@item.Status</td>
                            <td>@(item.Create_Date.HasValue ? item.Create_Date.Value.ToString("yyyy-MM-dd"): "")</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5">No Asset found</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</section>
<script>
    (function () {
        function fetchCompanyName(companyCode) {
            if (companyCode) {
                $.ajax({
                    url: '@Url.Action("GetCompanyNameByCode", "AssetManagement")',
                    type: 'GET',
                    data: { companyCode: companyCode },
                    success: function (data) {
                        $('#Company_Name').val(data);
                    }, error: function (error) {
                        console.error("Error Loading company name:", error)
                        $('#Company_Name').val("");
                        toastr.error("Error loading company name.");
                    }
                });
            } else {
                $('#Company_Name').val("");
            }
        }

        $(function () {

            if ($.fn.select2) {
                $('.select2').select2();
            }

            $("#companyCodeDropdown").on('change', function () {
                var companyCode = $(this).val();
                fetchCompanyName(companyCode);
            });

            var initialCompanyCode = $("#companyCodeDropdown").val();
            if (initialCompanyCode) {
                fetchCompanyName(initialCompanyCode);
            }

            function handleStatusFormDisplay() {

                $(".status-form").hide();

                var status = $("#statusDropdown").val();
                if (!status || status === "") {
                    return;
                }

                switch (status) {
                    case 'Return':
                        $('#returnForm').show();
                        break;
                    case 'Borrowing':
                        $('#borrowForm').show();
                        break;
                    case 'Service':
                        $('#serviceForm').show();
                        break;
                    case 'Ready':
                        $('#readyForm').show();
                        break;
                    case 'Assign':
                        $('#assignForm').show();
                        break;
                    case 'Write Off':
                        $('#writeOffForm').show();
                        break;
                }
            }

            $("#statusDropdown").on('change', function () {

                handleStatusFormDisplay();
            });
            handleStatusFormDisplay();





            $("#btnSearch").click(function () {
                var search = $("input[name='table_search']").val();
                $.ajax({
                    url: '@Url.Action("SearchAssetHistory", "AssetManagement")',
                    type: 'GET',
                    data: { search: search },
                    success: function (data) {
                        renderAssetHistory(data);
                    },
                    error: function (error) {
                        console.log(error);
                        toastr.error("Error searching asset history");
                    }
                });
            });


            function renderAssetHistory(data) {
                var tbody = $("#assetHistoryTable");
                tbody.empty();

                if (data && data.length > 0) {
                    $.each(data, function (i, item) {
                        var row = "<tr>" +
                            "<td>" + (item.No_asset || "") + "</td>" +
                            "<td>" + (item.PIC || "") + "</td>" +
                            "<td>" + formatDate(item.Transaction_Date) + "</td>" +
                            "<td>" + (item.Status || "") + "</td>" +
                            "<td>" + formatDate(item.Submit_Date) + "</td>" +
                            "</tr>";
                        tbody.append(row);
                    });
                } else {
                    tbody.append("<tr><td colspan='5'>No data found</td></tr>");
                }
            }
            function formatDate(dateString) {
                if (!dateString) return "";

                try {

                    if (typeof dateString === 'string' && dateString.indexOf('/Date(') === 0) {
                        var timeStamp = parseInt(dateString.substr(6));
                        var date = new Date(timeStamp);
                        if (isNaN(date.getTime())) return "";

                        var year = date.getFullYear();
                        var month = (date.getMonth() + 1).toString().padStart(2, '0');
                        var day = date.getDate().toString().padStart(2, '0');
                        return year + '-' + month + '-' + day;
                    } else {

                        var date = new Date(dateString);
                        if (isNaN(date.getTime())) return "";

                        var year = date.getFullYear();
                        var month = (date.getMonth() + 1).toString().padStart(2, '0');
                        var day = date.getDate().toString().padStart(2, '0');
                        return year + '-' + month + '-' + day;
                    }
                } catch (e) {
                    console.error("Error parsing date:", e);
                    return "";
                }
            }


            $("#btnCancel").click(function () {
                window.location.href = '@Url.Action("Index", "Home")';
            });

            $("#btnCancelStatus").click(function () {
                $("#statusDropdown").val("").trigger("change");
                $(".status-form").hide();
            });

            $("#btnSave").click(function (e) {
                e.preventDefault();
                if (!$("#No_asset").val()) {
                    toastr.error("No Asset is required.");
                    return;
                }
                if (!$("#companyCodeDropdown").val()) {
                    toastr.error("Company Code is required");
                    return;
                }
                var status = $("#statusDropdown").val();
                if (!status) {
                    toastr.error("Status Is Required");
                    return;
                }

                var picValue = "";
                var dateValue = "";

                switch (status) {
                    case 'Return':
                        picValue = $("#returnPIC").val();
                        dateValue = $("#returnDate").val();
                        break;
                    case 'Borrowing':
                        picValue = $("#borrowPIC").val();
                        dateValue = $("#borrowDate").val();
                        break;
                    case 'Service':
                        picValue = $("#servicePIC").val();
                        dateValue = $("#serviceDate").val();
                        break;
                    case 'Ready':
                        picValue = $("#readyPIC").val();
                        dateValue = $("#readyDate").val();
                        break;
                    case 'Assign':
                        picValue = $("#assignPIC").val();
                        dateValue = $("#assignDate").val();
                        break;
                    case 'Write Off':
                        picValue = $("#writeOffPIC").val();
                        dateValue = $("#writeOffDate").val();
                        break;
                }

                if (!picValue) {
                    toastr.error("PIC is required.");
                    return;
                }
                if (!dateValue) {
                    toastr.error("Transaction Date is required.");
                    return;
                }

                $("#hiddenPIC").val(picValue);
                $("#hiddenTransactionDate").val(dateValue);

                console.log("form data before submit",{
                    NoAsset: $("#No_asset").val(),
                        Status: status,
                            PIC: picValue,
                    TransactionDate: dateValue,
                                FormData: $("#assetForm").serialize()
                });


                $.ajax({
                    url: $("#assetForm").attr("action"),
                    type: 'POST',
                    data: $("#assetForm").serialize(),
                    success: function (data) {
                        if (data.success) {
                            toastr.success(data.message);

                            var tbody = $("#assetHistoryTable");
                            var assetData = data.assetData;
                            var row = "<tr>" +
                                "<td>" + (assetData.No_asset || "") + "</td>" +
                                "<td>" + (assetData.PIC || "") + "</td>" +
                                "<td>" + (assetData.Transaction_Date || "") + "</td>" +
                                "<td>" + (assetData.Status || "") + "</td>" +
                                "<td>" + (assetData.Create_Date || "") + "</td>" +
                                "</tr>";
                           
                            if (tbody.find("tr td[colspan='5']").length > 0) {
                                tbody.empty();
                            }
                            tbody.prepend(row);
                            resetFormFields();
                        } else {
                            toastr.error(data.message);
                            console.error("Error from server ", data.message)
                        }
                    },
                        error: function (xhr,status ,error) {
                            console.error("Error saving asset:", xhr.responseText);
                            toastr.error("Error saving asset, please try again");
                    }
                });
            });
            function resetFormFields() {
                
                $("#statusDropdown").val("").trigger("change");
                $(".status-form input").val("");
                $("#hiddenPIC").val("");
                $("#hiddenTransactionDate").val("");
            }
       
        });
    })();



</script>